(()=>{"use strict";var e,t,s,a,o={newTab:!0,newWindow:!0,tabSwitch:!0},r={},n=!1,i="",c=!1,d=!1;async function m(){await chrome.offscreen.hasDocument()||await chrome.offscreen.createDocument({url:"offscreen.html",reasons:["WEB_RTC"],justification:"Exam screen monitoring"})}function u(){chrome.tabs.query({active:!0,currentWindow:!0},(function(a){var o=a[0];null==e&&(e=o.id),null==t&&(t=o.windowId),t&&(chrome.windows.update(t,{state:"fullscreen"}),s=!0)}))}function l(){chrome.windows.getCurrent((function(e){s=!1,o.newTab=!0,o.newWindow=!0,o.tabSwitch=!0,"fullscreen"!=e.state&&"maximized"!=e.state||chrome.windows.update(e.id,{state:"maximized",focused:!0})}))}async function h(){let e=(await chrome.storage.local.get(["expiryDuration"])).expiryDuration;if(e){r.expiryDuration=r.expiryDuration||e;var t={type:"LOCAL_STORAGE_DATA"};t.data=r,await chrome.runtime.sendMessage(t)}chrome.runtime.sendMessage({type:"clean_db"})}function p(e,t){return{type:e,id:t}}function E(){c&&(+r.preview||(chrome.action.setBadgeText({text:"REC"}),chrome.action.setBadgeBackgroundColor({color:"green"}),chrome.runtime.sendMessage({type:"START_MONITORING"}),d=!0,c=!1),r.recIcon=!0,r.isSubmmitted=!1)}function g(e=!0){r.recIcon=!1,r.isSubmmitted=e,e?function(){let e=r.candidateServiveV2+"candidate/exam/submit",t={examId:r.examId,sessionId:r.sessionId};fetch(e,{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:"Bearer "+r.token,webReferer:r.webReferer},body:JSON.stringify(t)}).then((e=>e.json())).then((e=>{200===e.status&&y()})).catch((e=>{console.log(e)}))}():y(),chrome.runtime.sendMessage({type:"STOP_MONITORING"})}function y(){l(),c=!1,d=!1,chrome.action.setBadgeText({text:"OFF"}),chrome.action.setBadgeBackgroundColor({color:"red"});chrome.runtime.sendMessage({type:"Emit_Socket_Event"}),chrome.tabs.sendMessage(e,p("REMOVE_BLOCKER","hardwareAccessPrompt")),chrome.tabs.sendMessage(e,p("REMOVE_BLOCKER","cameraAccessPrompt")),chrome.tabs.sendMessage(e,p("REMOVE_BLOCKER","cameraRecIcon")),chrome.tabs.sendMessage(e,{type:"DisableRightClick",data:!0}),chrome.runtime.sendMessage({type:"SOCKET_DISCONNECTED"})}self.onmessage=e=>{},chrome.runtime.onInstalled.addListener((async()=>{chrome.action.setBadgeText({text:"OFF"}),await m(),setInterval((()=>{h()}),36e5)})),chrome.management.onEnabled.addListener((async()=>{chrome.action.setBadgeText({text:"OFF"}),await m(),h(),setInterval((()=>{h()}),36e5)})),chrome.runtime.onMessageExternal.addListener(((s,a,m)=>{(async()=>{if(!chrome.runtime.lastError){const[w]=await chrome.tabs.query({active:!0,currentWindow:!0});var a={...s};if("ENABLE_EXTENSION"===s.type)e=w.id,t=w.windowId,r={},n=!1,i="",c=!1,d=!1,await chrome.scripting.executeScript({target:{tabId:w.id},files:["detect.js"]}),chrome.runtime.sendMessage(a),a.permission="OK",m(a);else if("EXTENSION_CHECK"===s.type)a.permission="OK",s?.data?.dbName&&(r.dbName=s?.data?.dbName,(h={type:"init_db"}).data=r.dbName,chrome.runtime.sendMessage(h)),m(a);else if("EXTENSION_VERSION"===s.type)a.extensionVersion="1.2.1",a.permission="OK",m(a);else if("PERMISSION"===s.type){const e=await chrome.tabs.sendMessage(w.id,s);m(e)}else if("STORE_EXAM_DETAILS"===s.type){var h;r={...r,...s.data},(h={type:"LOCAL_STORAGE_DATA"}).data=r,chrome.runtime.sendMessage(h),chrome.storage.local.set(s.data),m(a)}else if("SCREEN_SHARE"==s.type){let e=await chrome.runtime.sendMessage(s);a.permission=e,m(a)}else if("VERIFY_IDENTITY"==s.type)s.data.fullScreen&&(o.newTab=!1,o.newWindow=!1,o.tabSwitch=!1,u()),chrome.tabs.update(e,{active:!0,selected:!0}),c=!0,a.status=200,m(a);else if("START_MONITORING"==s.type)c&&(+r.preview||(chrome.action.setBadgeText({text:"REC"}),chrome.action.setBadgeBackgroundColor({color:"green"}),chrome.runtime.sendMessage({type:"START_MONITORING"}),d=!0,c=!1),r.recIcon=!0,r.isSubmmitted=!1),a.status=200,m(a);else if("STOP_MONITORING"==s.type){chrome.runtime.sendMessage(s),l(),chrome.action.setBadgeText({text:"OFF"}),chrome.action.setBadgeBackgroundColor({color:"red"});let e={type:"Emit_Socket_Event"};chrome.runtime.sendMessage(e),a.status=200,r.recIcon=!1,m(a)}else if("SCREENSHARE_EXTENSION_COUNT"==s.type){var p={type:"SCREENSHARE_COUNT"};p.data=r;var E=await chrome.runtime.sendMessage(p);E.status=200,m(E)}else if("VIDEO_EXTENSION_COUNT"==s.type){var g={type:"VIDEO_COUNT"};g.data=r;var y=await chrome.runtime.sendMessage(g);y.status=200,m(y)}}})()})),chrome.windows.onBoundsChanged.addListener((function(e){s&&u()})),chrome.tabs.query({windowType:"normal"},(function(e){a=e.length})),chrome.tabs.onActivated.addListener((function(t){o.tabSwitch||(chrome.tabs.update(e,{active:!0,selected:!0}),e!=t.tabId&&chrome.tabs.update(t.tabId,{active:!1,selected:!1}))})),chrome.tabs.onCreated.addListener((function(t){o.newTab||(e!=t.id&&null!=e||a>1)&&chrome.tabs.remove(t.id)})),chrome.windows.onFocusChanged.addListener((function(e){o.newWindow||-1==e&&e==t||chrome.windows.update(t,{focused:!0})})),chrome.windows.onCreated.addListener((function(e){chrome.windows.getAll((function(t){o.newWindow||t.length>1&&chrome.windows.remove(e.id)}))})),chrome.runtime.onMessage.addListener(((t,s,a)=>{(async()=>{if(!chrome.runtime.lastError){if("EXIT_FULLSCREEN"===t.type)l();else if("ia-ie-masterstart"===t.type||"Emit_Socket_Event"===t.type)chrome.runtime.sendMessage(t);else if("SHOW_SCREENSHARE_PROMPT"===t.type||"REMOVE_BLOCKER"===t.type){const s=await chrome.tabs.sendMessage(e,t);a(s)}else if("CAMERA_INTERRUPTED"===t.type){let s={type:"STOP_CAMERA",data:t};r.devices=t.devices,t.productFamilyCode=r.productFamilyCode,chrome.runtime.sendMessage(s);const o=await chrome.tabs.sendMessage(e,t);a(o)}else if("START_CAMERA"===t.type){r.deviceId=t.data.deviceId,r.deviceLabel=t.data.deviceLabel;let s={type:"ALLOW_CAMERA_ACCESS",data:t.data};chrome.runtime.sendMessage(s);const o=await chrome.tabs.sendMessage(e,t);a(o)}else"QUIZ_PASSWORD"===t.type?a({password:i}):"BEFORE_QUIZ_PASSWORD"===t.type?a({verifyIdentity:c,startMonitoringFlag:d,productFamilyCode:r?.productFamilyCode}):"POPUP_SYNCH_COMPLETED"===t.type?r.isSubmmitted=!1:chrome.tabs.sendMessage(e,t,(e=>{a(e)}));setTimeout((function(){a({status:!0})}),1)}})()})),chrome.tabs.onRemoved.addListener((function(t,s,a){if(e==t){r.recIcon=!1,c=!1;let e={type:"STOP_MONITORING"};chrome.runtime.sendMessage(e);let t={type:"SOCKET_DISCONNECTED"};chrome.runtime.sendMessage(t)}})),chrome.tabs.onUpdated.addListener((function(t,s,a){e==t&&"complete"==s.status&&chrome.scripting.executeScript({target:{tabId:a.id},files:["detect.js"]}).then((()=>{if(a.url){if(r.recIcon){let t={type:"ALLOW_CAMERA_REC_ACCESS",productFamilyCode:r?.productFamilyCode};chrome.tabs.sendMessage(e,t),chrome.tabs.sendMessage(e,{type:"DisableRightClick",data:!1})}else chrome.tabs.sendMessage(e,p("REMOVE_BLOCKER","cameraRecIcon"));if(r.isSubmmitted){let t={type:"ENABLE_SYNCH_PROGRESS"};chrome.tabs.sendMessage(e,t)}}})).catch((e=>{console.log(e)}))})),chrome.tabs.onAttached.addListener((s=>{null!=e&&s==e&&chrome.tabs.get(e,(e=>{t=e.windowId}))})),chrome.webRequest.onBeforeRedirect.addListener((function(e){e.url.includes("/mod/quiz/startattempt.php")&&"moodle"==r?.productFamilyCode?n=!0:(e.url.includes("login/logout.php")||e.url.includes("loginas.php"))&&"moodle"==r?.productFamilyCode?g(!1):e.url.includes("iproctor=")&&"desire2learn"==r?.productFamilyCode&&(i=e.url)}),{urls:["<all_urls>"]}),chrome.webRequest.onCompleted.addListener((function(e){e.url.includes("user/attempt/quiz_start_frame_auto.d2l")&&"desire2learn"==r?.productFamilyCode?E():e.url.includes("user/quiz_submissions_attempt.d2l")&&"desire2learn"==r?.productFamilyCode||e.url.includes("/mod/quiz/review.php")&&"moodle"==r?.productFamilyCode?g():e.url.includes("/mod/quiz/attempt.php")&&n?(n=!1,E()):(e.url.includes("/d2l/login?logout=1")||e.url.includes("user/quiz_summary.d2l?shouldFocus=true"))&&"desire2learn"==r?.productFamilyCode?g(!1):e.url.includes("iproctor=")&&"desire2learn"==r?.productFamilyCode&&(i=e.url)}),{urls:["<all_urls>"]})})();