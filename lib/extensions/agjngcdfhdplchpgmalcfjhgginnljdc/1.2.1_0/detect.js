(()=>{if(!document.getElementById("cameraSource")){var e=document.createElement("iframe");e.style.display="none",e.src=chrome.runtime.getURL("./cameraSources.html"),e.id="cameraSource",e.allow="camera",document.body.appendChild(e)}if(!document.getElementById("audioSources")){var t=document.createElement("iframe");t.style.display="none",t.src=chrome.runtime.getURL("./audioSources.html"),t.id="audioSources",t.allow="microphone",document.body.appendChild(t)}var n="",r=[],o=0,i=0,c=0,a=0;interval="",window.addEventListener("keydown",(function(e){if(e.altKey&&"q"==e.key){let e={type:"EXIT_FULLSCREEN"};chrome.runtime.sendMessage(e,(e=>{chrome.runtime.lastError||console.log(e)}))}}));var d,s=0;function l(e){e.preventDefault()}function u(){chrome.runtime.sendMessage({type:"SCREEN_SHARE"})}function p(e){let t=document.querySelector("#"+e);t&&t.remove(),w(!1)}function m(e){var t=e.target.value;n=r.filter((e=>e.deviceId==t))[0]}function h(e){var t={type:"START_CAMERA",data:{deviceLabel:n.label,deviceId:n.deviceId}};chrome.runtime.sendMessage(t),y(0,e.target.examCode)}function y(e,t=""){p("cameraRecIcon");let n="",r="",o="",i="";var c=document.createElement("div");"moodle"==t?n=document.querySelector(".nav-item"):"desire2learn"==t?i=document.querySelector("iframe").contentWindow.length>0?document.querySelector("iframe").contentWindow[0].headerFrame||document.querySelector("iframe").contentWindow.headerFrame:null:"Assessapp"==t&&(r=document.querySelector(".timer-icon"));let a=i;i&&(i=i.document.querySelector(".d2l-quizzing-header .dco_c")),c.setAttribute("id","cameraRecIcon"),n?(c.style.cssText="background: #fff;padding: 0 5px;float: left;margin-right: 10px;position: relative;top: 5px;",o=n):i?(c.style.cssText="background: #fff;padding: 0 5px;float: left;margin-right: 10px;position: relative;top: 0px;",o=i):r&&(c.style.cssText="background: #fff;padding: 0 5px;float: right;",o=r);var d=document.createElement("img");if(d.src=chrome.runtime.getURL("assets/hardware/recording.gif"),d.style.cssText="margin-top: 0;line-height: 20px;width:40px;height:auto",c.appendChild(d),a)a.document.querySelector("#cameraRecIcon")||o.insertBefore(c,o.children[1]);else if(location.href.includes("enhancedSequenceViewer")&&"desire2learn"==t){let e=document.querySelector("d2l-sequence-viewer").shadowRoot.children["view-container"].children.viewframe.children[0].shadowRoot.children[0].shadowRoot.children[2].children.content.contentWindow[0].headerFrame;o=e.document.querySelector(".d2l-quizzing-header .dco_c"),e.document.querySelector("#cameraRecIcon")||o?.insertBefore(c,o.children[1])}else o.insertBefore(c,o.firstChild);document.getElementById("cameraRecIcon").addEventListener("click",g)}function g(){p("synchAccessPrompt");var e=document.createElement("div");e.setAttribute("id","synchAccessPrompt"),e.style.cssText="position: absolute;z-index: 99999;width: 100%;height: 100%;display: flex;align-items: center;justify-content: center;text-align: center;top:0;";var t=document.createElement("div");t.style.cssText="position: absolute;width: 100%;height: 100%;background-color: black;opacity: 0.3;";var n=document.createElement("div");n.setAttribute("id","contentPrompt"),n.style.cssText="position: absolute;width: 50%;height: auto;background-color: white;opacity: 1;padding: 30px;border-radius: 5px;";var r=document.createElement("img");r.src=chrome.runtime.getURL("assets/synch/warning.png"),r.style.cssText="margin-top: 0;line-height: 20px;width:40px;height:auto";var o=document.createElement("p");o.innerHTML="<h2 id='titleContent'></h2><br/>You have successfully submitted your Exam. We are now in the process of syncing the final responses to the server. Once they are synced, you will be prompted to log out of the system.<br/>Please do not close this alert or Exam window until the sync is complete.",o.prepend(r);var i=document.createElement("div");i.setAttribute("class","progress-bar-container"),i.style.cssText="margin: auto;margin-top: 30px;border: 1px solid #ccc;height: 20px;position: relative;";var c=document.createElement("div");c.setAttribute("class","progress-bar"),c.style.cssText="height:19px;background-color: #77d44e;transition: all 1s;width:0%",i.append(c),o.appendChild(i);var a=document.createElement("span");a.setAttribute("id","synchContent"),o.appendChild(a),o.style.cssText="margin-top: 0;line-height: 20px;",e.appendChild(t),e.appendChild(n),n.appendChild(o),document.body.appendChild(e),w(!0),v()}async function v(){let e=await chrome.runtime.sendMessage(f("SCREENSHARE_COUNT")),t=await chrome.runtime.sendMessage(f("VIDEO_COUNT")),n=document.querySelector("#titleContent");if(e)i=e,"ScreenShotExtension",n.innerText="Extension Screenshot Sync in Progress",x("SCREENSHARE_COUNT");else if(t)i=t,"VideoExtension",n.innerText="Extension Video Sync in Progress",x("VIDEO_COUNT");else if(0==e&&0==t){var r=document.querySelector("#contentPrompt");r.innerHTML="<p>Exam Responses have been successfully synced to the server.</p>";var o=document.createElement("button");o.innerText="Close popup",o.setAttribute("id","closeBtn"),o.style.cssText="height: 35px;width: 200px;border: 0;background-color: green;color: white;cursor: pointer;",r.append(o),document.getElementById("closeBtn").addEventListener("click",E)}}function x(e){interval&&clearInterval(interval),interval=setInterval((()=>{chrome.runtime.sendMessage(f(e),(e=>{if(chrome.runtime.lastError||function(e){c=i-(o=e);let t=document.querySelector("#synchContent");t&&(t.innerHTML="<p><strong>"+c+" </strong>out of <strong>"+i+" </strong> items synced successfully.</p>"),c<0&&(c=(i=o)-o),a=isNaN(i)||isNaN(c)?0:(c/i*100).toFixed(3),document.querySelector(".progress-bar").style.width=a+"%"}(e),e<=0)return v(),void clearInterval(interval)}))}),1e3)}function E(){chrome.runtime.sendMessage(f("POPUP_SYNCH_COMPLETED")),p("synchAccessPrompt")}function w(e){!function(){if(!document.getElementById("iproctor-ext-style")){var e=document.createElement("style");e.setAttribute("id","iproctor-ext-style"),e.innerHTML=".hideScroll { overflow: hidden; }",document.getElementsByTagName("head")[0].append(e)}}(),document.body.classList.remove("hideScroll"),e&&document.body.classList.add("hideScroll")}function f(e){return returnRequest={type:e}}chrome.runtime.sendMessage({type:"BEFORE_QUIZ_PASSWORD"},(e=>{e.verifyIdentity&&!e.startMonitoringFlag&&"desire2learn"==e.productFamilyCode?d=setInterval((()=>{s<20?(s++,chrome.runtime.sendMessage({type:"QUIZ_PASSWORD"},(e=>{let t=new URL(e?.password),n=t?.searchParams,r=n?.get("iproctor");r&&location.href.includes("enhancedSequenceViewer")&&document.querySelector("d2l-sequence-viewer")?.shadowRoot?.children["view-container"]?.children.viewframe?.children[0].shadowRoot?.children[0]?.shadowRoot?.children[2]?.children.content?.contentWindow?.document.querySelector("input[type='password']")?(document.querySelector("d2l-sequence-viewer").shadowRoot.children["view-container"].children.viewframe.children[0].shadowRoot.children[0].shadowRoot.children[2].children.content.contentWindow.document.querySelector("input[type='password']").value=r,d&&clearInterval(d)):r&&document.querySelector("iframe")?.contentWindow?.document.querySelector("input[type='password']")&&(document.querySelector("iframe").contentWindow.document.querySelector("input[type='password']").value=r,d&&clearInterval(d))}))):d&&clearInterval(d)}),1e3):d&&clearInterval(d)})),document.onkeydown=function(e){if(123==window.event.keyCode||2==e.button)return!1},chrome.runtime.onMessage.addListener((function(e,t,n){if(!chrome.runtime.lastError)return e.type&&"SHOW_SCREENSHARE_PROMPT"==e.type?(function(){p("hardwareAccessPrompt");var e=document.createElement("div");e.setAttribute("id","hardwareAccessPrompt"),e.style.cssText="position: absolute;z-index: 99999;width: 100%;height: 100%;display: flex;align-items: center;justify-content: center;text-align: center;top:0;";var t=document.createElement("div");t.style.cssText="position: absolute;width: 100%;height: 100%;background-color: black;opacity: 0.3;";var n=document.createElement("div");n.style.cssText="position: absolute;width: 400px;height: auto;background-color: white;opacity: 1;padding: 30px;border-radius: 5px;";var r=document.createElement("p");r.innerText="Screen share has been stopped. Click allow screen share button to share your screen.",r.style.cssText="margin-top: 0;line-height: 20px;";var o=document.createElement("button");o.innerText="Allow Screen Share",o.setAttribute("id","screenShareBtn"),o.style.cssText="height: 35px;width: 200px;border: 0;background-color: green;color: white;cursor: pointer;",e.appendChild(t),e.appendChild(n),n.appendChild(r),n.appendChild(o),document.body.appendChild(e),w(!0),document.getElementById("screenShareBtn").addEventListener("click",u)}(),n(!0)):e.type&&"REMOVE_BLOCKER"==e.type?(p(e.id),n(!0)):e.type&&"CAMERA_INTERRUPTED"==e.type?(function(e){p("cameraAccessPrompt");var t=document.createElement("div");t.setAttribute("id","cameraAccessPrompt"),t.style.cssText="position: absolute;z-index: 99999;width: 100%;height: 100%;display: flex;align-items: center;justify-content: center;text-align: center;top:0;";var n=document.createElement("div");n.style.cssText="position: absolute;width: 100%;height: 100%;background-color: black;opacity: 0.3;";var o=document.createElement("div");o.style.cssText="position: absolute;width: 400px;height: auto;background-color: white;opacity: 1;padding: 30px;border-radius: 5px;";var i=document.createElement("p");i.innerText="Camera has been stopped. Select the dropdown option and select the Allow Camera button.",r=e.devices;var c='<br/><div style="display: flex;padding: 0px;margin: 0px;position: relative;top: 7px;padding-top: 5px;"><span >select Camera : </span><select  id="cameraDrop"><option value=-1>select Camera</option>';r.forEach((function(e){"videoinput"==e.kind&&(c+="<option value="+e.deviceId+">"+e.label+"</option>")})),c+="</select></div>",i.innerHTML+=c,i.style.cssText="margin-top: 0;line-height: 20px;";var a=document.createElement("button");a.innerText="Allow Camera",a.setAttribute("id","cameraBtn"),a.style.cssText="height: 35px;width: 200px;border: 0;background-color: green;color: white;cursor: pointer;",t.appendChild(n),t.appendChild(o),o.appendChild(i),o.appendChild(a),document.body.appendChild(t),w(!0);const d=document.querySelector("#cameraBtn");d.addEventListener("click",h,!1),d.examCode=e?.productFamilyCode,document.getElementById("cameraDrop").addEventListener("change",m)}(e),p("cameraRecIcon"),n(!0)):e.type&&"DisableRightClick"===e.type?(e.data,window.removeEventListener("contextmenu",l),e.data||window.addEventListener("contextmenu",l),n(!0)):e.type&&"ALLOW_CAMERA_REC_ACCESS"==e.type?(y(0,e?.productFamilyCode),n(!0)):e.type&&"ENABLE_SYNCH_PROGRESS"==e.type&&g(),!0}))})();