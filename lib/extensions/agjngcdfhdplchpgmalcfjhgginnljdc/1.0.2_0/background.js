(()=>{var e,t,a,s,n={newTab:!0,newWindow:!0,tabSwitch:!0},o={},i=null;async function r(){await chrome.offscreen.hasDocument()||await chrome.offscreen.createDocument({url:"offscreen.html",reasons:["WEB_RTC"],justification:"Exam screen monitoring"})}function c(){chrome.tabs.query({active:!0,currentWindow:!0},(function(s){var n=s[0];null==e&&(e=n.id),null==t&&(t=n.windowId),t&&(chrome.windows.update(t,{state:"fullscreen"}),a=!0)}))}function d(){chrome.windows.getCurrent((function(e){a=!1,n.newTab=!0,n.newWindow=!0,n.tabSwitch=!0,"fullscreen"!=e.state&&"maximized"!=e.state||chrome.windows.update(e.id,{state:"maximized",focused:!0})}))}async function m(){let e=(await chrome.storage.local.get(["expiryDuration"])).expiryDuration;if(e){o.expiryDuration=o.expiryDuration||e;var t={type:"LOCAL_STORAGE_DATA"};t.data=o,await chrome.runtime.sendMessage(t)}chrome.runtime.sendMessage({type:"clean_db"})}function u(e,t){return screenrequest={type:e,id:t}}self.onmessage=e=>{},chrome.runtime.onInstalled.addListener((async()=>{chrome.action.setBadgeText({text:"OFF"}),await r(),setInterval((()=>{m()}),36e5)})),chrome.management.onEnabled.addListener((async()=>{chrome.action.setBadgeText({text:"OFF"}),await r(),m(),setInterval((()=>{m()}),36e5)})),chrome.runtime.onMessageExternal.addListener(((a,s,i)=>{(async()=>{if(!chrome.runtime.lastError){const[E]=await chrome.tabs.query({active:!0,currentWindow:!0});var s={...a};if("ENABLE_EXTENSION"===a.type)e=E.id,t=E.windowId,o={},await chrome.scripting.executeScript({target:{tabId:E.id},files:["detect.js"]}),chrome.runtime.sendMessage(s),s.permission="OK",i(s);else if("EXTENSION_CHECK"===a.type)s.permission="OK",a?.data?.dbName&&(o.dbName=a?.data?.dbName,(r={type:"init_db"}).data=o.dbName,chrome.runtime.sendMessage(r)),i(s);else if("PERMISSION"===a.type){const e=await chrome.tabs.sendMessage(E.id,a);i(e)}else if("STORE_EXAM_DETAILS"===a.type){var r;o={...o,...a.data},(r={type:"LOCAL_STORAGE_DATA"}).data=o,chrome.runtime.sendMessage(r),chrome.storage.local.set(a.data),i(s)}else if("SCREEN_SHARE"==a.type){let e=await chrome.runtime.sendMessage(a);s.permission=e,i(s)}else if("START_MONITORING"==a.type)n.newTab=!1,n.newWindow=!1,n.tabSwitch=!1,chrome.tabs.update(e,{active:!0,selected:!0}),c(),+o.preview||(chrome.action.setBadgeText({text:"REC"}),chrome.action.setBadgeBackgroundColor({color:"green"}),chrome.runtime.sendMessage(a)),s.status=200,o.recIcon=!0,i(s);else if("STOP_MONITORING"==a.type){chrome.runtime.sendMessage(a),d(),chrome.action.setBadgeText({text:"OFF"}),chrome.action.setBadgeBackgroundColor({color:"red"});let e={type:"Emit_Socket_Event"};chrome.runtime.sendMessage(e),s.status=200,o.recIcon=!1,console.log(o),i(s)}else if("SCREENSHARE_EXTENSION_COUNT"==a.type){var m={type:"SCREENSHARE_COUNT"};m.data=o;var u=await chrome.runtime.sendMessage(m);u.status=200,i(u)}else if("VIDEO_EXTENSION_COUNT"==a.type){var h={type:"VIDEO_COUNT"};h.data=o;var l=await chrome.runtime.sendMessage(h);l.status=200,i(l)}}})()})),chrome.windows.onBoundsChanged.addListener((function(e){a&&c()})),chrome.tabs.query({windowType:"normal"},(function(e){s=e.length})),chrome.tabs.onActivated.addListener((function(t){n.tabSwitch||(chrome.tabs.update(e,{active:!0,selected:!0}),e!=t.tabId&&chrome.tabs.update(t.tabId,{active:!1,selected:!1}))})),chrome.tabs.onCreated.addListener((function(t){n.newTab||(e!=t.id&&null!=e||s>1)&&chrome.tabs.remove(t.id)})),chrome.windows.onFocusChanged.addListener((function(e){n.newWindow||-1==e&&e==t||chrome.windows.update(t,{focused:!0})})),chrome.windows.onCreated.addListener((function(e){chrome.windows.getAll((function(t){n.newWindow||t.length>1&&chrome.windows.remove(e.id)}))})),chrome.runtime.onMessage.addListener(((t,a,s)=>{(async()=>{if(!chrome.runtime.lastError){if("EXIT_FULLSCREEN"===t.type)d();else if("ia-ie-masterstart"===t.type||"Emit_Socket_Event"===t.type)chrome.runtime.sendMessage(t);else if("SHOW_SCREENSHARE_PROMPT"===t.type||"REMOVE_BLOCKER"===t.type){const a=await chrome.tabs.sendMessage(e,t);s(a)}else if("CAMERA_INTERRUPTED"===t.type){let a={type:"STOP_CAMERA",data:t};o.devices=t.devices,chrome.runtime.sendMessage(a);const n=await chrome.tabs.sendMessage(e,t);s(n)}else if("START_CAMERA"===t.type){o.deviceId=t.data.deviceId,o.deviceLabel=t.data.deviceLabel;let a={type:"ALLOW_CAMERA_ACCESS",data:t.data};chrome.runtime.sendMessage(a);const n=await chrome.tabs.sendMessage(e,t);s(n)}else chrome.tabs.sendMessage(e,t,(e=>{s(e)}));setTimeout((function(){s({status:!0})}),1)}})()})),chrome.tabs.onRemoved.addListener((function(t,a,s){if(console.log(t,a,s),e==t){o.recIcon=!1;let e={type:"STOP_MONITORING"};chrome.runtime.sendMessage(e);let t={type:"SOCKET_DISCONNECTED"};chrome.runtime.sendMessage(t)}})),chrome.tabs.onUpdated.addListener((function(t,a,s){e==t&&"complete"==a.status&&chrome.scripting.executeScript({target:{tabId:s.id},files:["detect.js"]}).then((()=>{let t=["/mod/quiz/attempt.php","/mod/quiz/summary.php"],a=["/mod/quiz/view.php","/mod/quiz/review.php"];if(s.url){if(o.recIcon){let t={type:"ALLOW_CAMERA_REC_ACCESS"};chrome.tabs.sendMessage(e,t),chrome.tabs.sendMessage(e,{type:"DisableRightClick",data:!1})}else chrome.tabs.sendMessage(e,u("REMOVE_BLOCKER","cameraRecIcon"));let n=t.find((e=>s.url.includes(e))),r=a.find((e=>s.url.includes(e)));if(n)i="inExam";else if("inExam"==i&&r){i=null;let t={type:"STOP_MONITORING"};o.recIcon=!1,function(){let t=o.candidateServiveV2+"candidate/exam/submit",a={examId:o.examId,sessionId:o.sessionId};fetch(t,{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8",Authorization:"Bearer "+o.token,webReferer:o.webReferer},body:JSON.stringify(a)}).then((e=>e.json())).then((t=>{if(200===t.status){d(),chrome.action.setBadgeText({text:"OFF"}),chrome.action.setBadgeBackgroundColor({color:"red"});let t={type:"Emit_Socket_Event"};chrome.runtime.sendMessage(t),chrome.tabs.sendMessage(e,u("REMOVE_BLOCKER","hardwareAccessPrompt")),chrome.tabs.sendMessage(e,u("REMOVE_BLOCKER","cameraAccessPrompt")),chrome.tabs.sendMessage(e,u("REMOVE_BLOCKER","cameraRecIcon")),chrome.tabs.sendMessage(e,{type:"DisableRightClick",data:!0})}})).catch((e=>{console.log(e)}))}(),chrome.runtime.sendMessage(t)}}})).catch((e=>{console.log(e)}))}))})();